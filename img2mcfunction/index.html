<!DOCTYPE html>
<head>
	<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?">
	<title>图片转mcfunction | By Dislink</title>
	<script src="/javascript/palettes.js" type="text/javascript"></script>
	<script src="/javascript/jszip.min.js" type="text/javascript"></script>
	<script src="/javascript/FileSaver.js" type="text/javascript"></script>
	<script src="/javascript/Math.uuid.js" type="text/javascript"></script>
	<script>
		manifestBE={"format_version":1,"header":{"description":"url:https://dislink.github.io/img2mcfunction","name":"","uuid":"","min_engine_version":[1,13,0],"version":[0,0,1]},"modules":[{"description":"","type":"data","uuid":"","version":[0,0,1]}]};
	</script>
	<script>
		function getMousePos(canvas, event){
			return [Math.round(event.clientX - canvas.getBoundingClientRect().left * canvas.width / canvas.getBoundingClientRect().width + 1), Math.round(event.clientY - canvas.getBoundingClientRect().top * canvas.height / canvas.getBoundingClientRect().height + 1)]
		}
		function getBlock(r, g, b, palette, mode=0/*true:标准差最小 false:方差最小*/, rWeight=1/*红色权重*/, gWeight=1/*绿色权重*/, bWeight=1/*蓝色权重*/, caWeight=1/*相对差值权重*/){
			let diffMin=Infinity;
			let diffMinItem;
			for(let item in palette){
				if((mode?((Math.abs(palette[item].R-r)*rWeight+Math.abs(palette[item].G-g)*gWeight+Math.abs(palette[item].B-b)*bWeight)-(caWeight?((((palette[item].R-r)/(r?r:1))-((palette[item].G-g)/(g?g:1)))**2+(((palette[item].G-g)/(g?g:1))-((palette[item].B-b)/(b?b:1)))**2+(((palette[item].B-b)/(b?b:1))-((palette[item].R-r)/(r?r:1)))**2)*caWeight:0)):(((palette[item].R-r)**2*rWeight+(palette[item].G-g)**2*gWeight+(palette[item].B-b)**2*bWeight)-(caWeight?((((palette[item].R-r)/(r?r:1))-((palette[item].G-g)/(g?g:1)))**2+(((palette[item].G-g)/(g?g:1))-((palette[item].B-b)/(b?b:1)))**2+(((palette[item].B-b)/(b?b:1))-((palette[item].R-r)/(r?r:1)))**2)*caWeight:0)))<diffMin){
					diffMin=(mode?((Math.abs(palette[item].R-r)*rWeight+Math.abs(palette[item].G-g)*gWeight+Math.abs(palette[item].B-b)*bWeight)):(((palette[item].R-r)**2*rWeight+(palette[item].G-g)**2*gWeight+(palette[item].B-b)**2*bWeight)));
					diffMinItem=palette[item];
				}
			}
			return diffMinItem;
		}
	</script>
	<style>
		input::-webkit-outer-spin-button,
		input::-webkit-inner-spin-button {
			-webkit-appearance: none;
		}
		input[type="number"] {
			-moz-appearance: textfield;
			width: 2rem;
		}
		body {
			background-color: white;
		}
	</style>
</head>
<body>
	<form id="arguments">
		<input type="file" id="upload" accept="image/*">
		 <label for="upload">上传图片</label>
		<br/>
		<fieldset id="img_info" style="display: none;">
		<legend>图片信息</legend>
			<h3 id="img_size"></h3>
		</fieldset>
		<fieldset id="convert_args">
		<legend>转换参数</legend>
			<input type="range" id="rWeightScroll" min="0" max="10" value="1" step="0.01" />
			<label for="rWeightScroll">红色差值权重</label>
			<input type="number" id="rWeight" step="0.01" value="1" />
			<input type="range" id="rScaleScroll" min="0" max="200" value="100" step="0.1"/>
			<label for="rScaleScroll">红色缩放比例</label>
			<input type="number" id="rScale" step="0.1" value="100" />
			<label for="rScale">%</label>
			<br/>
			<input type="range" id="gWeightScroll" min="0" max="10" value="1" step="0.01" />
			<label for="gWeightScroll">绿色差值权重</label>
			<input type="number" id="gWeight" step="0.01" value="1" />
			<input type="range" id="gScaleScroll" min="0" max="200" value="100" step="0.1" />
			<label for="gScaleScroll">绿色缩放比例</label>
			<input type="number" id="gScale" step="0.1" value="100" />
			<label for="gScale">%</label>
			<br/>
			<input type="range" id="bWeightScroll" min="0" max="10" value="1" step="0.01" />
			<label for="bWeightScroll">蓝色差值权重</label>
			<input type="number" id="bWeight" step="0.01" value="1" />
			<input type="range" id="bScaleScroll" min="0" max="200" value="100" step="0.1" />
			<label for="bScaleScroll">蓝色缩放比例</label>
			<input type="number" id="bScale" step="0.1" value="100" />
			<label for="bScale">%</label>
			<br/>
			<input type="range" id="caWeightScroll" min="0" max="10" value="0" step="0.1" />
			<label for="caWeightScroll">色差校准权重(Exp)</label>
			<input type="number" id="caWeight" step="0.1" value="0" />
			<select id="fitMode">
				<option value="stdDev" selected>标准差最小</option>
				<option value="stdSqr">标准平方和最小</option>
			</select>
			<label for="commandPlatform">拟合方式</label>
		</fieldset>
		<fieldset id="command_args">
		<legend>命令参数</legend>
			<input type="range" id="xRange" min="1" max="98" value="96" />
			<label for="xRange">图片x轴function分割上限 96</label>
			<br/>
			<input type="range" id="yRange" min="1" max="98" value="96" />
			<label for="yRange">图片y轴function分割上限 96</label>
			</br>
			</br>
			<input type="checkbox" id="relativePos" checked />
			<label for="relativePos">使用相对坐标(~)</label>
			<input type="checkbox" id="guideFunction" checked />
			<label for="guideFunction">添加引导function</label>
			<input type="checkbox" id="guideCommand" checked />
			<label for="guideCommand">function结尾添加引导命令</label>
			<select id="commandPlatform">
				<option value="BE" selected>基岩版</option>
				<option value="JE">JAVA版</option>
			</select>
			<label for="commandPlatform">命令版本</label>
		</fieldset>
		<br/>
	</form>
	<canvas id="img_preview" title="图片预览" style="display: none;"></canvas>
	<br/>
	<button id="convert" style="display: none;">转换</button>
	<button id="download" style="display: none;">下载文件</button>
	<br/>
	<div id="status"></div>
	<canvas id="convert_preview" title="转换预览" style="display: none;"></canvas>
	<script>
		var img=new Image;rWeightScroll.onchange=e=>{rWeight.value=e.target.value},rWeight.onchange=e=>{rWeightScroll.value=e.target.value},rScaleScroll.onchange=e=>{rScale.value=e.target.value},rScale.onchange=e=>{rScaleScroll.value=e.target.value},gWeightScroll.onchange=e=>{gWeight.value=e.target.value},gWeight.onchange=e=>{gWeightScroll.value=e.target.value},gScaleScroll.onchange=e=>{gScale.value=e.target.value},gScale.onchange=e=>{gScaleScroll.value=e.target.value},bWeightScroll.onchange=e=>{bWeight.value=e.target.value},bWeight.onchange=e=>{bWeightScroll.value=e.target.value},bScaleScroll.onchange=e=>{bScale.value=e.target.value},bScale.onchange=e=>{bScaleScroll.value=e.target.value},caWeightScroll.onchange=e=>{caWeight.value=e.target.value},caWeight.onchange=e=>{caWeightScroll.value=e.target.value},xRange.onchange=e=>{e.target.labels[0].textContent="图片x轴function分割上限 "+e.target.value,yRange.max=Math.floor((1e4-(guideCommand?2:0))/e.target.value)},yRange.onchange=e=>{e.target.labels[0].textContent="图片y轴function分割上限 "+e.target.value,xRange.max=Math.floor((1e4-(guideCommand?2:0))/e.target.value)},upload.onchange=()=>{var e;upload.files[0]&&((e=new FileReader).onload=()=>{img.src=e.result,convert.style="display: block;",status.innerText='文件已改变，请点击"转换"按钮以应用改变'},e.readAsDataURL(upload.files[0]))},img.onload=()=>{download.style="display: none;",img_preview.width=img.width,img_preview.height=img.height,img_preview.style="display: block;",img_size.innerText=`宽：${img.width}    高：`+img.height,img_info.style="display: block;",img_preview.getContext("2d").drawImage(img,0,0,img.width,img.height)},convert_args.onchange=()=>{document.getElementById("status").innerText="参数已改变，请"+(upload.files[0]?'点击"转换"按钮':"上传图片")+"以应用改变"},convert.onclick=()=>{upload.files[0]?(document.getElementById("status").innerText="正在转换...",setTimeout(()=>{imgConvert()},50)):document.getElementById("status").innerText="请上传图片文件"},download.onclick=()=>{if(!blocks)return alert("没有什么可下载的");let l=[],i=[];for(let a=0;a<img_preview.height;a+=parseFloat(yRange.value))for(let e=0;e<img_preview.width;e+=parseFloat(xRange.value))i[Math.floor(e/parseFloat(xRange.value))+","+Math.floor(a/parseFloat(yRange.value))]=[],l.push(Math.floor(e/parseFloat(xRange.value))+","+Math.floor(a/parseFloat(yRange.value)));for(var e in blocks)i[Math.floor(blocks[e][0]/parseFloat(xRange.value))+","+Math.floor(blocks[e][1]/parseFloat(yRange.value))].push([blocks[e][0]%parseFloat(xRange.value),blocks[e][1]%parseFloat(yRange.value),blocks[e][3]]);"BE"==commandPlatform.value&&(zip=new JSZip,functions=zip.folder("functions")),guideFunction.checked&&("JE"==commandPlatform?saveAs(new Blob([`say 图片信息：宽：${img.width}  高：${img.height}    图像命令总长度：${img.width*img.height}    function文件数：${l.length}
say 输入/function "${l[0].replace(",","-")}"以启动`],{type:"text/plainText"}),"help.mcfunction"):functions.file("help.mcfunction",`say 图片信息：宽：${img.width}  高：${img.height}    图像命令总长度：${img.width*img.height}    function文件数：${l.length}
say 输入/function "${l[0].replace(",","-")}"以启动`));let o=0,g=setInterval(()=>{var e,a=l[o];let t="";for(e in i[a])t+=`setblock ${relativePos.checked?"~"+Math.round(i[a][e][0]-parseFloat(xRange.value)/2)+" ~ ~"+Math.round(i[a][e][1]-parseFloat(yRange.value)/2):Math.round(parseFloat(a.split(",")[0])*parseFloat(xRange.value)+i[a][e][0])+" ~ "+Math.round(parseFloat(a.split(",")[1])*parseFloat(yRange.value)+i[a][e][1])} ${i[a][e][2]}
`;guideCommand.checked&&(t+=l[o+1]?`tp @s ${(relativePos.checked?"~":"")+Math.round(relativePos.checked?(parseFloat(l[o+1].split(",")[0])-parseFloat(l[o].split(",")[0]))*parseFloat(xRange.value):0)+" ~ "+(relativePos.checked?"~":"")+Math.round(relativePos.checked?(parseFloat(l[o+1].split(",")[1])-parseFloat(l[o].split(",")[1]))*parseFloat(yRange.value):0)}
say 已传送至下一执行位点,请勿自行移动！请等待区块加载完成后输入/function "${l[parseFloat(o)+1].replace(",","-")}"继续生成`:"say 生成完成！"),"JE"==commandPlatform.value?saveAs(new Blob([t],{type:"text/plainText"}),a.replace(",","-")+".mcfunction"):functions.file(a.replace(",","-")+".mcfunction",t),++o>=l.length&&(manifestBE.header.name=fileName,manifestBE.header.uuid=Math.uuid(),manifestBE.modules[0].uuid=Math.uuid(),zip.file("manifest.json",JSON.stringify(manifestBE)),zip.generateAsync({type:"blob"}).then(function(e){saveAs(e,fileName+".mcpack")}),clearInterval(g))},"JE"==commandPlatform.value?500:0)},imgConvert=()=>{convert_preview.width=img_preview.width,convert_preview.height=img_preview.height,fileName=upload.files[0].name,blocks=[],imageData=img_preview.getContext("2d").getImageData(0,0,img_preview.width,img_preview.height);for(let a=0;a<img_preview.height;a++)for(let e=0;e<img_preview.width;e++){var t=getBlock(imageData.data[4*(a*img_preview.width+e)]*(parseFloat(rScale.value)/100),imageData.data[4*(a*img_preview.width+e)+1]*(parseFloat(gScale.value)/100),imageData.data[4*(a*img_preview.width+e)+2]*(parseFloat(bScale.value)/100),"BE"==commandPlatform.value?paletteBE:paletteJE,"stdSqr"==fitMode.value,parseFloat(rWeight.value),parseFloat(gWeight.value),parseFloat(bWeight.value),parseFloat(caWeight.value));blocks.push([e,a,imageData.data[4*(a*img_preview.width+e)+3],t.name]),imageData.data[4*(a*img_preview.width+e)]=t.R,imageData.data[4*(a*img_preview.width+e)+2]=t.G,imageData.data[4*(a*img_preview.width+e)+2]=t.B}convert_preview.getContext("2d").putImageData(imageData,0,0),convert_preview.style="display: block;",document.getElementById("status").innerText="转换完成！",download.style="display: block;"},img_preview.onmousemove=e=>{var a=getMousePos(e.target,e),t=img_preview.getContext("2d").getImageData(a[0],a[1],1,1).data;e.target.title=`Pos: ${a[0]},${a[1]}  R:${t[0]} G:${t[1]} B:`+t[2]},convert_preview.onmousemove=e=>{var a=getMousePos(e.target,e),t=convert_preview.getContext("2d").getImageData(a[0],a[1],1,1).data,l=getBlock(t[0],t[1],t[2],"BE"==commandPlatform.value?paletteBE:paletteJE).name;e.target.title=`Pos: ${a[0]},${a[1]}  R:${t[0]} G:${t[1]} B:${t[2]}  Block:`+l};
	</script>
</body>
