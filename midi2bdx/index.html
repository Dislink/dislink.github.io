<!DOCTYPE html>
<head>
	<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?">
	<title>MIDI转BDX | By Dislink</title>
	<script src="MIDIFile.js" type="text/javascript"></script>
	<script src="brotli-js.js" type="text/javascript"></script>
	<script src="FileSaver.js" type="text/javascript"></script>
	<script>
		function formatSeconds(value) {
　　		return `${Math.floor(value / 3600) < 10 ? '0' + Math.floor(value / 3600) : Math.floor(value / 3600)}:${Math.floor((value / 60 % 60)) < 10 ? '0' + Math.floor((value / 60 % 60)) : Math.floor((value / 60 % 60))}:${Math.floor((value % 60)) < 10 ? '0' + Math.floor((value % 60)) : Math.floor((value % 60))}`
		}
	</script>
	<script>
		BDXFileHdr=[66,68,64]//"BD@"
		BDXDataP1=[66,68,88,0,68,105,115,108,105,110,107,95,83,102,111,114,122,97,0]//"BDX\x00Dislink_Sforza\x00"
		BDXDataEnd=[88,69];//XE
		function pointerMove(x, y, z){
			let result='';
			if(x) result+="\x15"+String.fromCharCode((x&0xff000000)>>>24, (x&0xff0000)>>>16, (x&0xff00)>>>8, (x&0xff));
			if(y) result+="\x17"+String.fromCharCode((y&0xff000000)>>>24, (y&0xff0000)>>>16, (y&0xff00)>>>8, (y&0xff));
			if(z) result+="\x19"+String.fromCharCode((z&0xff000000)>>>24, (z&0xff0000)>>>16, (z&0xff00)>>>8, (z&0xff));
			return result;
		}
		function placeCommandBlockWithCommandBlockData(data/*[Y-,Y+,Z-,Z+,X-,X+]*/, mode/*脉冲 = 0, 循环 = 1, 连锁 = 2*/, command, hoverText, ticksDelay, needsRedstone){
			return String.fromCharCode(0x24, (data&0xff00)>>>8, data&0xff, (mode&0xff000000)>>>24, (mode&0xff0000)>>>16, (mode&0xff00)>>>8, (mode&0xff))+command+'\x00'+hoverText+'\x00\x00'+String.fromCharCode((ticksDelay&0xff000000)>>>24, (ticksDelay&0xff0000)>>>16, (ticksDelay&0xff00)>>>8, ticksDelay&0xff)+"\x01"+"\x00"+"\x00"+String.fromCharCode(needsRedstone);
		}
		</script>
	<script>
	function getSoundString(program, channel=0){
		if(channel!==9){
			if([105].includes(program)) return 'note.banjo';
			if([32,33,34,35,36,37,38,39].includes(program)) return 'note.bass';
			if([115,116,117,118].includes(program)) return 'note.basedrum'
			if([9].includes(program)) return 'note.bell';
			if([80,81].includes(program)) return 'note.bit';
			if([112].includes(program)) return 'note.cow_bell';
			//if([].includes(program)) return 'note.didgeridoo';
			if([72,73,74,75,76,77,78,79].includes(program)) return 'note.flute';
			if([24,25,26,27,28,29,30,31].includes(program)) return 'note.guitar';
			if([14].includes(program)) return 'note.chime';
			if([8,9,10,11,12,13,/*14,*/15].includes(program)) return 'note.iron_xylophone';
			if([2].includes(program)) return 'note.pling';
			return 'note.harp';
		}else{
			if([55].includes(program)) return 'note.cow_bell';
			if([41,43,45].includes(program)) return 'note.hat';
			if([36,37,39].includes(program)) return 'note.snare';
			return 'note.basedrum';
		}
	}	
	</script>
	<style>
		input::-webkit-outer-spin-button,
		input::-webkit-inner-spin-button {
			-webkit-appearance: none;
		}
		input[type="number"] {
			-moz-appearance: textfield;
			width: 3rem;
		}
		body {
			background-color: white;
		}
	</style>
</head>
<body>
	<form id="arguments">
		<input type="file" id="upload" accept="audio/midi">
		 <label for="upload">上传midi文件</label>
		<br/>
		<fieldset id="mid_info" style="display: none;">
		<legend>MIDI信息</legend>
			<h3 id="timeTotal"></h3>
			<h3 id="tracksCount"><h3>
			<h3 id="noteOnCount"><h3>
			<h3 id="instrumentsCount"><h3>
		</fieldset>
		<fieldset id="convert_args">
		<legend>转换参数</legend>
			<input type="range" id="speedScroll" min="1" max="400" value="100" step="0.1"/>
			<label for="speedScroll">速度百分比</label>
			<input type="number" id="speed" step="0.1" value="100" />
			<label for="speed">%</label>
			<br/>
			<input type="range" id="volume4MainScroll" min="0" max="1" value="0.9" step="0.01"/>
			<label for="olume4MainScroll">主音轨音量衰减系数</label>
			<input type="number" id="volume4Main" step="0.01" value="0.9" />
			<br/>
			<input type="range" id="volume4SubScroll" min="0" max="1" value="0.7" step="0.01"/>
			<label for="volume4SubScroll">副音轨音量衰减系数</label>
			<input type="number" id="volume4Sub" step="0.01" value="0.7" />
			<label for="convertTracks" style="display:none;">转换音轨</label>
			<select id="convertTracks" multiple="true" style="display:none;">
			</select>
			<br>
			<input type="checkbox" id="ignorePercussionInstrument" />
			<label for="ignorePercussionInstrument">忽略打击乐器</label>
			<br/>
			<input type="checkbox" id="convertToHarp" />
			<label for="convertToHarp">全部使用钢琴音色</label>
			<br/>
		</fieldset>
		<fieldset id="command_args">
		<legend>bdx、命令参数</legend>
			<input type="range" id="xLengthScroll" min="1" max="256" value="32" />
			<label for="xLengthScroll">x轴延伸长度</label>
			<input type="number" id="xLength" step="1" value="32" />
			<label for="xLength">block(s)</label>
			<br/>
			<input type="range" id="zLengthScroll" min="1" max="256" value="32" />
			<label for="zLengthScroll">z轴延伸长度</label>
			<input type="number" id="zLength" step="1" value="32" />
			<label for="zLength">block(s)</label>
			<br/>
			<label for="text">玩家选择器</label>
			<input type="text" id="playerSelector" value="@a" />
			<br/>
			<label for="commandVersion">命令版本</label>
			<select id="commandVersion">
				<option value="formal"  selected>旧execute语法规范</option>
				<option value="new">新execute语法规范</option>
				<option value="no-execute">不使用execute(不推荐，可能影响效果)</option>
			</select>
		</fieldset>
		<br/>
	</form>
	<br/>
	<button id="download" style="display: none;">下载文件</button>
	<br/>
	<div id="status"></div>
	<script>
		speedScroll.onchange=(e)=>{
			speed.value=e.target.value;
		}
		speed.onchange=(e)=>{
			speedScroll.value=e.target.value;
		}
		xLengthScroll.onchange=(e)=>{
			xLength.value=e.target.value;
		}
		xLength.onchange=(e)=>{
			xLengthScroll.value=e.target.value;
		}
		zLengthScroll.onchange=(e)=>{
			zLength.value=e.target.value;
		}
		zLength.onchange=(e)=>{
			zLengthScroll.value=e.target.value;
		}
		volume4MainScroll.onchange=(e)=>{
			volume4Main.value=e.target.value;
		}
		volume4Main.onchange=(e)=>{
			volume4MainScroll.value=e.target.value;
		}
		volume4SubScroll.onchange=(e)=>{
			volume4Sub.value=e.target.value;
		}
		volume4Sub.onchange=(e)=>{
			volume4SubScroll.value=e.target.value;
		}
		upload.onchange=(()=>{
			if(!upload.files[0]) return;
			var fr=new FileReader();
			fr.onload=()=>{
				try{
					midiFile=new MIDIFile(fr.result);
					for(let i in midiFile.getEvents()){
						midiFile.timeTotal=(midiFile.timeTotal>midiFile.getEvents()[i].slice(-1)[0].playTime?midiFile.timeTotal:midiFile.getEvents()[i].slice(-1)[0].playTime)
					}
					document.getElementById("timeTotal").innerText="总时长："+formatSeconds(Math.round(midiFile.timeTotal/1000));
					document.getElementById("tracksCount").innerText="总音轨数："+midiFile.header.getTracksCount();
					document.getElementById("noteOnCount").innerText="总音符数："+midiFile.getEvents([MIDIEvents.EVENT_MIDI],[MIDIEvents.EVENT_MIDI_NOTE_ON], [], true)[0].length;
					soundStrings=[];
					for(let n in midiFile.getEvents([MIDIEvents.EVENT_MIDI],[MIDIEvents.EVENT_MIDI_PROGRAM_CHANGE], [], true)[0]){
						soundStrings[midiFile.getEvents([MIDIEvents.EVENT_MIDI],[MIDIEvents.EVENT_MIDI_PROGRAM_CHANGE], [], true)[0][n].track]=getSoundString(midiFile.getEvents([MIDIEvents.EVENT_MIDI],[MIDIEvents.EVENT_MIDI_PROGRAM_CHANGE], [], true)[0][n].param1);
					}
					document.getElementById("instrumentsCount").innerText="总乐器数："+(midiFile.getEvents([MIDIEvents.EVENT_MIDI],[MIDIEvents.EVENT_MIDI_PROGRAM_CHANGE], [], true)[0].length+1);
					document.getElementById("convertTracks").innerHTML='';
					for(let i in midiFile.tracks){
						let trackOption=document.createElement("option");
						trackOption.value=i;
						trackOption.selected=true;
						trackOption.innerText=`Track #${i}`;
						document.getElementById("convertTracks").appendChild(trackOption);
					}
					document.getElementById("convertTracks").labels[0].style="display: block";
					document.getElementById("convertTracks").style="display: block";
					document.getElementById("mid_info").style="display: block;";
					document.getElementById("download").style="display: block;";
					fileName=upload.files[0].name;
				}catch(e){
					document.getElementById("status").innerText=e.toString().split('\n')[0];
				}
			}
			fr.readAsArrayBuffer(upload.files[0]);
		})
		download.onclick=(()=>{
			tracksSelected=[];
			for(let i in convertTracks.children){
				if(convertTracks.children[i].selected){
					tracksSelected.push(parseInt(i));
				}
			}
			notes=midiFile.getEvents([MIDIEvents.EVENT_MIDI],[MIDIEvents.EVENT_MIDI_NOTE_ON], tracksSelected, true)[0].sort((a,b)=>{return a.playTime>b.playTime});
			let seq=0;
			data=''
			let x=0,y=0,z=0;
			let tx=0,ty=0,tz=0;
			let xBackward=false,zBackward=false;
			while((y*parseInt(xLength.value)*parseInt(zLength.value)+x*parseInt(zLength.value)+z)<notes.length){
				for(x=0;x<parseInt(xLength.value);x++){
					for(z=0;z<parseInt(zLength.value);z++){/*[Y-,Y+,Z-,Z+,X-,X+]*/
					w=['Y-','Y+','Z-','Z+','X-','X+']
						console.log(`${'x:'+tx+',y:'+ty+',z:'+tz+'   data:'}`+w[(z==parseInt(zLength.value)-1?(x==parseInt(xLength.value)-1?1:(xBackward?4:5)):(zBackward?2:3))])
						data+=placeCommandBlockWithCommandBlockData((z==parseInt(zLength.value)-1?(x==parseInt(xLength.value)-1?1:(xBackward?4:5)):(zBackward?2:3)), ((x==0&&y==0&&z==0)?0:2), `${(commandVersion.value=="no-execute")?'':(commandVersion.value=="formal")?"execute "+playerSelector.value+" ~~~ ":"execute as "+playerSelector.value+" run "}playsound ${convertToHarp.checked?"note.harp":(notes[(y*parseInt(xLength.value)*parseInt(zLength.value)+x*parseInt(zLength.value)+z)].channel==9?getSoundString(notes[(y*parseInt(xLength.value)*parseInt(zLength.value)+x*parseInt(zLength.value)+z)].param1,9):(soundStrings[notes[(y*parseInt(xLength.value)*parseInt(zLength.value)+x*parseInt(zLength.value)+z)].track]?soundStrings[notes[(y*parseInt(xLength.value)*parseInt(zLength.value)+x*parseInt(zLength.value)+z)].track]:"note.harp"))} @${commandVersion.value=="no-execute"?"a":"s"} ~~8~ ${(notes[(y*parseInt(xLength.value)*parseInt(zLength.value)+x*parseInt(zLength.value)+z)].param2*(notes[(y*parseInt(xLength.value)*parseInt(zLength.value)+x*parseInt(zLength.value)+z)].channel==0?parseFloat(volume4Main.value):parseFloat(volume4Sub.value)))} ${notes[(y*parseInt(xLength.value)*parseInt(zLength.value)+x*parseInt(zLength.value)+z)].channel==9?'':(2**((notes[(y*parseInt(xLength.value)*parseInt(zLength.value)+x*parseInt(zLength.value)+z)].param1-66)/12))}`, ((x==0&&y==0&&z==0)?"Start":'x:'+tx+',y:'+ty+',z:'+tz+' data:'+w[(z==parseInt(zLength.value)-1?(x==parseInt(xLength.value)-1?1:(xBackward?4:5)):(zBackward?2:3))]),((y*parseInt(xLength.value)*parseInt(zLength.value)+x*parseInt(zLength.value)+z)?Math.round((notes[(y*parseInt(xLength.value)*parseInt(zLength.value)+x*parseInt(zLength.value)+z)].playTime-notes[(y*parseInt(xLength.value)*parseInt(zLength.value)+x*parseInt(zLength.value)+z-1)].playTime)/(50*(parseFloat(speed.value)/100))):Math.round((notes[(y*parseInt(xLength.value)*parseInt(zLength.value)+x*parseInt(zLength.value)+z)].playTime)/(50*(parseFloat(speed.value)/100)))),((x==0&&y==0&&z==0)?true:false));
						(z==parseInt(zLength.value)-1)?'':tz+=(zBackward==false?1:-1)
						data+=(z==parseInt(zLength.value)-1)?'':pointerMove(0,0,(zBackward==false?1:-1));
					}
					(x==parseInt(xLength.value)-1?ty+=1:tx+=(xBackward==false?1:-1))
					data+=(x==parseInt(xLength.value)-1?pointerMove(0,1,0):pointerMove((xBackward==false?1:-1),0,0));
					zBackward=!zBackward;
				}
				xBackward=!xBackward;
				y++;
			}
			dataArray=new Array(data.length);
			for(let i in data){
				dataArray[i]=data.charCodeAt(i);
			}
			compressed=new Brotli().compressArray(Uint8Array.from(BDXDataP1.concat(dataArray.concat(BDXDataEnd))), 6);
			saveAs(new Blob([Uint8Array.from(BDXFileHdr.concat(Array.from(compressed)))]),"project.bdx")
		})
	</script>
</body>
